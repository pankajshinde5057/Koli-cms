{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}

{% block content %}
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card card-secondary">
                        <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
                            <div class="d-flex flex-column flex-md-row align-items-center w-100">
                                <form method="get" action="" class="w-100 mb-2 mb-md-0 mr-md-2">
                                    <div class="input-group input-group-sm">
                                        <input type="text" name="search" id="searchInput" class="form-control" placeholder="Search employees...">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="submit">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                <a href="{% url 'add_employee' %}" class="btn btn-sm btn-dark align-self-stretch align-self-md-center">
                                    <i class="fas fa-plus mr-1"></i> Add Employee
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="employeeTable" class="table table-bordered table-striped table-hover">
                                    <thead class="">
                                        <tr>
                                            <th>SN</th>
                                            <th>Full Name</th>
                                            <th>Email</th>
                                            <th class="d-none d-md-table-cell">Gender</th>
                                            <th class="d-none d-lg-table-cell">Division</th>
                                            <th class="d-none d-lg-table-cell">Department</th>
                                            <th>Avatar</th>
                                            <th>Assets</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if employees %}
                                            {% for employee in employees %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{employee.get_full_name }}</td>
                                                <td class="text-truncate" style="max-width: 150px;">{{employee.email}}</td>
                                                <td class="d-none d-md-table-cell">{{ employee.get_gender_display }}</td>
                                                <td class="d-none d-lg-table-cell">{{employee.employee.division.name}}</td>
                                                <td class="d-none d-lg-table-cell">{{employee.employee.department.name}}</td>
                                                <td class="text-center">
                                                    {% if employee.profile_pic %}
                                                    <img class="img img-fluid rounded-circle" height="40" width="40" src="{{employee.profile_pic}}" alt="Profile Pic">
                                                    {% else %}
                                                    <div class="avatar-placeholder rounded-circle">
                                                        <i class="fas fa-user"></i>
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm btn-info manage-devices" 
                                                            data-employee-id="{{ employee.id }}"
                                                            data-employee-name="{{ employee.first_name }} {{ employee.last_name }}"
                                                            data-toggle="modal" 
                                                            data-target="#deviceModal">
                                                        <i class="fas fa-laptop"></i> 
                                                        <span class="badge badge-light">{{ employee.assetsissuance_set.count }}</span>
                                                    </button>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="{% url 'edit_employee' employee.employee.id %}" class="btn btn-primary" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <a href="{% url 'delete_employee' employee.employee.id %}" class="btn btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this employee?');">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="9" class="text-center">No employees found in your team.</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Device Allocation Modal -->
    <div class="modal fade" id="deviceModal" tabindex="-1" role="dialog" aria-labelledby="deviceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="deviceModalLabel">Asset Management for <span id="modalEmployeeName"></span></h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <!-- Assigned Assets -->
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="card shadow-sm h-100">
                                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">Assigned Assets</h6>
                                    <span class="badge badge-light" id="assignedCount">0</span>
                                </div>
                                <div class="card-body p-0 d-flex flex-column">
                                    <div class="p-2">
                                        <button id="returnAllAssetsBtn" class="btn btn-sm btn-danger mb-2">
                                            <i class="fas fa-undo mr-1"></i> Return All
                                        </button>
                                        <button id="returnSelectedAssetsBtn" class="btn btn-sm btn-warning mb-2">
                                            <i class="fas fa-exchange-alt mr-1"></i> Return Selected
                                        </button>
                                    </div>
                                    <div id="allocatedAssetsList" class="list-group list-group-flush flex-grow-1" style="overflow-y: auto;">
                                        <div class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Available Assets + Bundle -->
                        <div class="col-md-6">
                            <div class="card shadow-sm h-100">
                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">Available Assets</h6>
                                    <span class="badge badge-light" id="availableCount">0</span>
                                </div>
                                <div class="card-body">
                                    <div class="form-group mb-2">
                                        <label for="assetLocation">Assignment Location:</label>
                                        <select id="assetLocation" class="form-control">
                                            {% for value, display in location_choices.items %}
                                                <option value="{{ value }}">{{ display }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Category Filter -->
                                    <div class="form-group mb-2">
                                        <label for="assetCategoryFilter">Filter by Category:</label>
                                        <select id="assetCategoryFilter" class="form-control">
                                            <option value="">All Categories</option>
                                        </select>
                                    </div>

                                    <!-- Search within category -->
                                    <div class="form-group mb-2">
                                        <div class="input-group">
                                            <input type="text" id="assetSearchInput" class="form-control" placeholder="Search assets...">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button" id="assetSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Available Assets Dropdown -->
                                    <div class="form-group mb-2">
                                        <label for="availableAssets">Select Assets:</label>
                                        <select id="availableAssets" class="form-control" multiple>
                                        </select>
                                    </div>

                                    <div class="d-flex flex-column">
                                        <!-- Bundle Button -->
                                        <button id="allocateBundleBtn" class="btn btn-warning mb-2">
                                            <i class="fas fa-cubes mr-1"></i> Assign Bundle
                                        </button>

                                        <!-- Allocate Selected Button -->
                                        <button id="allocateAssetBtn" class="btn btn-success">
                                            <i class="fas fa-plus-circle mr-1"></i> Assign Selected
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Toast for Messages -->
    <div class="toast" id="messageToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
        <div class="toast-header">
            <strong class="mr-auto">Notification</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">×</button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>

{% endblock content %}

{% block custom_js %}
    <script>
        // Initialize toast
        $('.toast').toast({ delay: 3000 });

        function showToast(message, type = 'success') {
            $('#toastMessage').text(message);
            $('.toast').removeClass('bg-success bg-danger').addClass('bg-' + type);
            $('.toast').toast('show');
        }

        // Device modal handling
        $('#deviceModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget);
            var employeeId = button.data('employee-id');
            var employeeName = button.data('employee-name');
            var modal = $(this);
            
            modal.find('#modalEmployeeName').text(employeeName);
            modal.data('employee-id', employeeId);
            
            // Load assigned assets
            loadAssignedAssets(employeeId);
            
            // Load available assets with no filter initially
            loadAvailableAssets(employeeId);
            
            // Load asset categories
            loadAssetCategories();
        });

        function loadAssetCategories() {
            $.get('{% url "get_asset_categories" %}', function(response) {
                var select = $('#assetCategoryFilter');
                select.empty().append('<option value="">All Categories</option>');
                if(response.success && response.categories && response.categories.length > 0) {
                    response.categories.forEach(function(category) {
                        select.append(new Option(category.name, category.id));
                    });
                } else {
                    select.append(new Option("No categories available", ""));
                    select.prop('disabled', true);
                }
            }).fail(function() {
                $('#assetCategoryFilter').html('<option>Error loading categories</option>');
                showToast('Error loading asset categories', 'danger');
            });
        }

        function loadAssignedAssets(employeeId) {
            $.get('{% url "get_assigned_assets" %}', {employee_id: employeeId}, function(response) {
                var html = '';
                if(response.success && response.assets && response.assets.length > 0) {
                    $('#assignedCount').text(response.assets.length);
                    response.assets.forEach(function(asset) {
                        html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input asset-checkbox" 
                                    data-asset-id="${asset.id}"
                                    data-issuance-id="${asset.issuance_id}"
                                    id="asset_${asset.id}">
                                <label class="form-check-label" for="asset_${asset.id}">
                                    <strong>${asset.asset_name}</strong><br>
                                    <small class="text-muted">${asset.asset_serial_number} (${asset.asset_category})</small>
                                </label>
                            </div>
                            <button class="btn btn-sm btn-warning remove-asset" 
                                    data-asset-id="${asset.id}"
                                    data-issuance-id="${asset.issuance_id}">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>`;
                    });
                } else {
                    html = '<div class="alert alert-info m-2">No assets assigned</div>';
                    $('#assignedCount').text('0');
                }
                $('#allocatedAssetsList').html(html);
            }).fail(function() {
                $('#allocatedAssetsList').html('<div class="alert alert-danger m-2">Error loading assets</div>');
            });
        }

        function loadAvailableAssets(employeeId, categoryId = '', searchQuery = '') {
            var select = $('#availableAssets');
            var allocateBtn = $('#allocateAssetBtn');

            // Clear previous options and reset state
            select.empty().prop('disabled', false);
            allocateBtn.prop('disabled', false);

            $.get('{% url "get_available_assets" %}', {
                category_id: categoryId,
                search: searchQuery
            }, function(response) {
                if(response.success && response.assets && response.assets.length > 0) {
                    $('#availableCount').text(response.assets.length);
                    response.assets.forEach(function(asset) {
                        select.append(new Option(
                            `${asset.asset_category}: ${asset.asset_name} (${asset.asset_serial_number})`, 
                            asset.id
                        ));
                    });
                } else {
                    select.append(new Option("No available assets found", ""));
                    select.prop('disabled', true);
                    allocateBtn.prop('disabled', true);
                    $('#availableCount').text('0');
                    showToast('No assets found for the current search', 'info');
                }
            }).fail(function() {
                select.html('<option>Error loading assets</option>');
                select.prop('disabled', true);
                allocateBtn.prop('disabled', true);
                $('#availableCount').text('0');
                showToast('Error loading assets', 'danger');
            });
        }

        // Category filter change
        $('#assetCategoryFilter').change(function() {
            var categoryId = $(this).val();
            var employeeId = $('#deviceModal').data('employee-id');
            var searchQuery = $('#assetSearchInput').val();
            loadAvailableAssets(employeeId, categoryId, searchQuery);
        });

        // Asset search
        $('#assetSearchBtn').click(function() {
            var categoryId = $('#assetCategoryFilter').val();
            var employeeId = $('#deviceModal').data('employee-id');
            var searchQuery = $('#assetSearchInput').val();
            loadAvailableAssets(employeeId, categoryId, searchQuery);
        });

        // Clear search input on double-click
        $('#assetSearchInput').on('dblclick', function() {
            $(this).val('');
            var categoryId = $('#assetCategoryFilter').val();
            var employeeId = $('#deviceModal').data('employee-id');
            loadAvailableAssets(employeeId, categoryId, '');
        });

        // Assign bundle assets
        $('#allocateBundleBtn').click(function() {
            var modal = $('#deviceModal');
            var employeeId = modal.data('employee-id');
            var location = $('#assetLocation').val();

            $.ajax({
                url: '{% url "get_available_assets" %}',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        var bundleAssets = response.bundle_assets || [];
                        
                        var expectedCategories = ['Laptop', 'Keyboard', 'Mouse', 'Cooling Pad', 'Monitor'];
                        var availableCategories = bundleAssets.map(asset => asset.asset_category.toLowerCase());
                        var missingCategories = expectedCategories.filter(category => !availableCategories.includes(category));

                        if (missingCategories.length > 0) {
                            var missingItemsText = missingCategories.join(', ');
                            showToast('Missing items in bundle: ' + missingItemsText, 'danger');
                            return;
                        }

                        if (confirm('Are you sure you want to bulk assign the bundle assets?')) {
                            var assetIds = bundleAssets.map(asset => asset.id);

                            $.ajax({
                                url: '{% url "assign_assets" %}',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    'employee_id': employeeId,
                                    'location': location,
                                    'asset_ids': assetIds,
                                }),
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                success: function(assignResponse) {
                                    if (assignResponse.success) {
                                        showToast(assignResponse.message, 'success');
                                        $('#deviceModal').modal('hide');
                                        setTimeout(() => window.location.reload(), 1000);
                                    } else {
                                        showToast(assignResponse.error, 'danger');
                                    }
                                },
                                error: function() {
                                    showToast('Server error while assigning bundle.', 'danger');
                                }
                            });
                        } else {
                            showToast('Bulk assignment cancelled.', 'info');
                        }
                    } else {
                        showToast('Error fetching bundle assets.', 'danger');
                    }
                },
                error: function() {
                    showToast('Server error while fetching bundle assets.', 'danger');
                }
            });
        });

        // Assign assets
        $('#allocateAssetBtn').click(function() {
            var modal = $('#deviceModal');
            var employeeId = modal.data('employee-id');
            var assetIds = $('#availableAssets').val();
            var location = $('#assetLocation').val();

            if(!assetIds || assetIds.length === 0) {
                showToast('Please select at least one asset', 'danger');
                return;
            }
            
            $.ajax({
                url: '{% url "assign_assets" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    'employee_id': employeeId,
                    'asset_ids': assetIds,
                    'location': location,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }),
                success: function(response) {
                    if(response.success) {
                        showToast('Assets assigned successfully');
                        $('#deviceModal').modal('hide');
                        window.location.reload();
                    } else {
                        showToast(response.error, 'danger');
                    }
                },
                error: function() {
                    showToast('Server error while assigning assets', 'danger');
                }
            });
        });

        // Return asset assignment (single)
        $(document).on('click', '.remove-asset', function() {
            if(!confirm('Are you sure you want to return this asset?')) return;
            
            var issuanceId = $(this).data('issuance-id');
            var assetId = $(this).data('asset-id');
            
            $.ajax({
                url: '{% url "remove_asset_assignment" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    'issuance_id': issuanceId,
                    'asset_id': assetId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }),
                success: function(response) {
                    if(response.success) {
                        showToast('Assignment returned successfully');
                        $('#deviceModal').modal('hide');
                        location.reload();
                    } else {
                        showToast(response.error, 'danger');
                    }
                },
                error: function() {
                    showToast('Server error while returning assignment', 'danger');
                }
            });
        });

        // Return selected assets
        $('#returnSelectedAssetsBtn').click(function() {
            var selectedAssets = [];
            $('.asset-checkbox:checked').each(function() {
                selectedAssets.push({
                    issuance_id: $(this).data('issuance-id'),
                    asset_id: $(this).data('asset-id')
                });
            });

            if(selectedAssets.length === 0) {
                showToast('Please select at least one asset to return', 'danger');
                return;
            }

            if(!confirm(`Are you sure you want to return ${selectedAssets.length} selected assets?`)) return;
            
            $.ajax({
                url: '{% url "remove_selected_asset_assignment" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    'assets': selectedAssets,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }),
                success: function(response) {
                    if(response.success) {
                        showToast('Selected assets returned successfully');
                        $('#deviceModal').modal('hide');
                        location.reload();
                    } else {
                        showToast(response.error, 'danger');
                    }
                },
                error: function() {
                    showToast('Server error while returning selected assets', 'danger');
                }
            });
        });

        // Return all assets
        $('#returnAllAssetsBtn').click(function() {
            var employeeId = $('#deviceModal').data('employee-id');
            if(!confirm('Are you sure you want to return ALL assets assigned to this employee?')) return;
            
            $.ajax({
                url: '{% url "remove_all_asset_assignment" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    'employee_id': employeeId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }),
                success: function(response) {
                    if(response.success) {
                        showToast('All assets returned successfully');
                        $('#deviceModal').modal('hide');
                        location.reload();
                    } else {
                        showToast(response.error, 'danger');
                    }
                },
                error: function() {
                    showToast('Server error while returning assets', 'danger');
                }
            });
        });

        // Phone number input filter with message
        $("#id_phone_number, #id_emergency_contact").on("input", function() {
            const original = this.value;
            const digitsOnly = original.replace(/\D/g, '');
            const warningId = this.id + "_warning";

            if (original !== digitsOnly) {
                if ($("#" + warningId).length === 0) {
                    $("<span id='" + warningId + "' class='invalid d-block mt-1'>Only digits are allowed</span>").insertAfter(this);
                }
            } else {
                $("#" + warningId).remove();
            }

            this.value = digitsOnly;
        });

        // Initialize Select2 for the assets dropdown
        $(document).ready(function() {
            $('#availableAssets').select2({
                placeholder: "Select assets to assign",
                width: '100%'
            });
        });
    </script>
{% endblock custom_js %}